#!/usr/bin/env bash
set -euo pipefail

# VALKYRIA ECM - CI Script
# Runs all checks required for continuous integration

echo "======================================"
echo "  VALKYRIA ECM - CI Pipeline"
echo "======================================"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILURES=0

# Function to run a step
run_step() {
  local name="$1"
  local cmd="$2"

  echo -e "${YELLOW}▶ Running: ${name}${NC}"
  if eval "$cmd"; then
    echo -e "${GREEN}✓ ${name} passed${NC}"
    echo ""
  else
    echo -e "${RED}✗ ${name} failed${NC}"
    echo ""
    FAILURES=$((FAILURES + 1))
  fi
}

# Step 1: Bundle check
run_step "Bundle Check" "bundle check || bundle install"

# Step 2: RuboCop
run_step "RuboCop (Linting)" "bundle exec rubocop --parallel"

# Step 3: Brakeman (Security)
run_step "Brakeman (Security Scan)" "bundle exec brakeman -q --no-pager -i config/brakeman.ignore"

# Step 4: RSpec (Tests)
run_step "RSpec (Tests)" "bundle exec rspec --format progress"

# Summary
echo "======================================"
if [ $FAILURES -eq 0 ]; then
  echo -e "${GREEN}✓ All CI checks passed!${NC}"
  exit 0
else
  echo -e "${RED}✗ ${FAILURES} check(s) failed${NC}"
  exit 1
fi
